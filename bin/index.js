#!/usr/bin/env node
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = require("fs");
const readline_1 = require("readline");
const path_1 = require("path");
const helpers_1 = require("yargs/helpers");
const yargs_1 = __importDefault(require("yargs/yargs"));
const Formator_1 = require("./lib/Formator");
const axios_1 = __importDefault(require("axios"));
const parser = (0, yargs_1.default)((0, helpers_1.hideBin)(process.argv))
    .option('type', {
    alias: 't',
    describe: 'Output format',
    default: Formator_1.types[0],
    choices: Formator_1.types
})
    .option('file', {
    alias: 'f',
    describe: 'File name',
    default: 'emojidb_result'
})
    .option('source', {
    alias: 's',
    describe: 'emoji-test.txt file or url',
    default: 'DS'
})
    .example('emojidb -t xml -f ~/yahaha', 'This command will output xml file which named "yahaha.xml" in user folder.')
    .example('emojidb -s https://www.unicode.org/Public/emoji/15.0/emoji-test.txt', 'This command will use the remote url like database source')
    .epilog('copyright (C) 2019-2023 phpz.xyz');
const emojiVersion = '15.0';
const defaultSource = '../source/emoji-test.txt';
void (async () => {
    const argv = await parser.argv;
    const source = argv.source === 'DS' ? (0, path_1.join)(__dirname, defaultSource) : argv.source;
    const output = `${argv.file}.${argv.type}`;
    let rl = null;
    let stream = null;
    if (/^https?:\/\//.test(source)) {
        console.log('🕖', `Loading... (${source})`);
        const response = await axios_1.default
            .get(source, {
            responseType: 'stream',
            headers: {
                'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36'
            }
        })
            .catch((err) => {
            console.error('⚠️', err.message);
            process.exit(1);
        });
        stream = response.data;
    }
    else {
        stream = (0, fs_1.createReadStream)(source);
    }
    stream.on('error', (err) => {
        console.error('⚠️', err.message);
        process.exit(1);
    });
    stream.on('open', () => {
        // console.log('BEGIN!');
    });
    rl = (0, readline_1.createInterface)({ input: stream });
    const data = { version: emojiVersion, emojis: [] };
    let curGroup = '';
    let curSubgroup = '';
    rl.on('line', (line) => {
        if (line.charAt(0) === '#') {
            const version = /#\s+version:\s+(.+)/i.exec(line);
            const group = /#\s+group:\s+(.+)/.exec(line);
            const subgroup = /#\s+subgroup:\s+(.+)/.exec(line);
            // version
            if (version != null) {
                data.version = version[1];
            }
            // group
            if (group != null) {
                curGroup = group[1];
            }
            // subgroup
            if (subgroup != null) {
                curSubgroup = subgroup[1];
            }
        }
        else {
            // emoji
            // # Format: code points; status # emoji name
            //           [1]          [2]      [3]   [4]
            const emojiInfo = /^([\w\s]+?)\s+;\s+([\w-]+)\s+#\s+(\S+)\s+(.+)/.exec(line);
            emojiInfo != null &&
                data.emojis.push({
                    group: curGroup,
                    subgroup: curSubgroup,
                    codepoints: emojiInfo[1].replace(/\s+/g, ','),
                    status: emojiInfo[2],
                    emoji: emojiInfo[3],
                    name: emojiInfo[4],
                    keywords: getKeyWords(curGroup, curSubgroup, emojiInfo[4])
                });
        }
    });
    rl.on('close', () => {
        (0, Formator_1.format)(data, argv.type)
            .then((result) => {
            (0, fs_1.writeFile)(output, result, (err) => {
                if (err != null) {
                    console.error('⚠️', err.message);
                }
                else {
                    console.log('✌️', `️Please run \`open "${output}"\` to check the output.`);
                }
            });
        })
            .catch((err) => {
            console.error('⚠️', err.message);
        });
    });
})();
const getKeyWords = (group, subgroup, name) => {
    const separator = /[\s&\-:]+/;
    let keywords = [];
    name = name.replace(/[()]/g, '');
    keywords = keywords.concat(group.toLowerCase().split(separator));
    keywords = keywords.concat(subgroup.toLowerCase().split(separator));
    keywords = keywords.concat(name.toLowerCase().split(separator));
    return Array.from(new Set(keywords)).join();
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUEsMkJBQWdEO0FBQ2hELHVDQUEwQztBQUUxQywrQkFBMkI7QUFDM0IsMkNBQXVDO0FBQ3ZDLHdEQUErQjtBQUUvQiw2Q0FBOEM7QUFDOUMsa0RBQXlCO0FBRXpCLE1BQU0sTUFBTSxHQUFHLElBQUEsZUFBSyxFQUFDLElBQUEsaUJBQU8sRUFBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDeEMsTUFBTSxDQUFDLE1BQU0sRUFBRTtJQUNkLEtBQUssRUFBRSxHQUFHO0lBQ1YsUUFBUSxFQUFFLGVBQWU7SUFDekIsT0FBTyxFQUFFLGdCQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLE9BQU8sRUFBRSxnQkFBSztDQUNmLENBQUM7S0FDRCxNQUFNLENBQUMsTUFBTSxFQUFFO0lBQ2QsS0FBSyxFQUFFLEdBQUc7SUFDVixRQUFRLEVBQUUsV0FBVztJQUNyQixPQUFPLEVBQUUsZ0JBQWdCO0NBQzFCLENBQUM7S0FDRCxNQUFNLENBQUMsUUFBUSxFQUFFO0lBQ2hCLEtBQUssRUFBRSxHQUFHO0lBQ1YsUUFBUSxFQUFFLDRCQUE0QjtJQUN0QyxPQUFPLEVBQUUsSUFBSTtDQUNkLENBQUM7S0FDRCxPQUFPLENBQ04sNEJBQTRCLEVBQzVCLDRFQUE0RSxDQUM3RTtLQUNBLE9BQU8sQ0FDTixxRUFBcUUsRUFDckUsMkRBQTJELENBQzVEO0tBQ0EsTUFBTSxDQUFDLGtDQUFrQyxDQUFDLENBQUE7QUFFN0MsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFBO0FBQzNCLE1BQU0sYUFBYSxHQUFHLDBCQUEwQixDQUFBO0FBRWhELEtBQUssQ0FBQyxLQUFLLElBQUksRUFBRTtJQUNmLE1BQU0sSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLElBQUksQ0FBQTtJQUM5QixNQUFNLE1BQU0sR0FDVixJQUFJLENBQUMsTUFBTSxLQUFL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SUFBSSxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNsQyxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUVKLE1BQU0sV0FBVyxHQUFHLENBQUMsS0FBYSxFQUFFLFFBQWdCLEVBQUUsSUFBWSxFQUFVLEVBQUU7SUFDNUUsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFBO0lBQzdCLElBQUksUUFBUSxHQUFhLEVBQUUsQ0FBQTtJQUUzQixJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFFaEMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO0lBQ2hFLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQTtJQUNuRSxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUE7SUFFL0QsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUE7QUFDN0MsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuXG5pbXBvcnQgeyBjcmVhdGVSZWFkU3RyZWFtLCB3cml0ZUZpbGUgfSBmcm9tICdmcydcbmltcG9ydCB7IGNyZWF0ZUludGVyZmFjZSB9IGZyb20gJ3JlYWRsaW5lJ1xuXG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCdcbmltcG9ydCB7IGhpZGVCaW4gfSBmcm9tICd5YXJncy9oZWxwZXJzJ1xuaW1wb3J0IHlhcmdzIGZyb20gJ3lhcmdzL3lhcmdzJ1xuXG5pbXBvcnQgeyBmb3JtYXQsIHR5cGVzIH0gZnJvbSAnLi9saWIvRm9ybWF0b3InXG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnXG5cbmNvbnN0IHBhcnNlciA9IHlhcmdzKGhpZGVCaW4ocHJvY2Vzcy5hcmd2KSlcbiAgLm9wdGlvbigndHlwZScsIHtcbiAgICBhbGlhczogJ3QnLFxuICAgIGRlc2NyaWJlOiAnT3V0cHV0IGZvcm1hdCcsXG4gICAgZGVmYXVsdDogdHlwZXNbMF0sXG4gICAgY2hvaWNlczogdHlwZXNcbiAgfSlcbiAgLm9wdGlvbignZmlsZScsIHtcbiAgICBhbGlhczogJ2YnLFxuICAgIGRlc2NyaWJlOiAnRmlsZSBuYW1lJyxcbiAgICBkZWZhdWx0OiAnZW1vamlkYl9yZXN1bHQnXG4gIH0pXG4gIC5vcHRpb24oJ3NvdXJjZScsIHtcbiAgICBhbGlhczogJ3MnLFxuICAgIGRlc2NyaWJlOiAnZW1vamktdGVzdC50eHQgZmlsZSBvciB1cmwnLFxuICAgIGRlZmF1bHQ6ICdEUydcbiAgfSlcbiAgLmV4YW1wbGUoXG4gICAgJ2Vtb2ppZGIgLXQgeG1sIC1mIH4veWFoYWhhJyxcbiAgICAnVGhpcyBjb21tYW5kIHdpbGwgb3V0cHV0IHhtbCBmaWxlIHdoaWNoIG5hbWVkIFwieWFoYWhhLnhtbFwiIGluIHVzZXIgZm9sZGVyLidcbiAgKVxuICAuZXhhbXBsZShcbiAgICAnZW1vamlkYiAtcyBodHRwczovL3d3dy51bmljb2RlLm9yZy9QdWJsaWMvZW1vamkvMTUuMC9lbW9qaS10ZXN0LnR4dCcsXG4gICAgJ1RoaXMgY29tbWFuZCB3aWxsIHVzZSB0aGUgcmVtb3RlIHVybCBsaWtlIGRhdGFiYXNlIHNvdXJjZSdcbiAgKVxuICAuZXBpbG9nKCdjb3B5cmlnaHQgKEMpIDIwMTktMjAyMyBwaHB6Lnh5eicpXG5cbmNvbnN0IGVtb2ppVmVyc2lvbiA9ICcxNS4wJ1xuY29uc3QgZGVmYXVsdFNvdXJjZSA9ICcuLi9zb3VyY2UvZW1vamktdGVzdC50eHQnXG5cbnZvaWQgKGFzeW5jICgpID0+IHtcbiAgY29uc3QgYXJndiA9IGF3YWl0IHBhcnNlci5hcmd2XG4gIGNvbnN0IHNvdXJjZSA9XG4gICAgYXJndi5zb3VyY2UgPT09ICdEUycgPyBqb2luKF9fZGlybmFtZSwgZGVmYXVsdFNvdXJjZSkgOiBhcmd2LnNvdXJjZVxuICBjb25zdCBvdXRwdXQgPSBgJHthcmd2LmZpbGV9LiR7YXJndi50eXBlfWBcblxuICBsZXQgcmwgPSBudWxsXG4gIGxldCBzdHJlYW0gPSBudWxsXG5cbiAgaWYgKC9eaHR0cHM/OlxcL1xcLy8udGVzdChzb3VyY2UpKSB7XG4gICAgY29uc29sZS5sb2coJ/CflZYnLCBgTG9hZGluZy4uLiAoJHtzb3VyY2V9KWApXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvc1xuICAgICAgLmdldChzb3VyY2UsIHtcbiAgICAgICAgcmVzcG9uc2VUeXBlOiAnc3RyZWFtJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdVc2VyLUFnZW50JzpcbiAgICAgICAgICAgICdNb3ppbGxhLzUuMCAoTWFjaW50b3NoOyBJbnRlbCBNYWMgT1MgWCAxMF8xNV83KSBBcHBsZVdlYktpdC81MzcuMzYgKEtIVE1MLCBsaWtlIEdlY2tvKSBDaHJvbWUvOTEuMC40NDcyLjExNCBTYWZhcmkvNTM3LjM2J1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4pqg77iPJywgZXJyLm1lc3NhZ2UpXG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKVxuICAgICAgfSlcbiAgICBzdHJlYW0gPSByZXNwb25zZS5kYXRhXG4gIH0gZWxzZSB7XG4gICAgc3RyZWFtID0gY3JlYXRlUmVhZFN0cmVhbShzb3VyY2UpXG4gIH1cblxuICBzdHJlYW0ub24oJ2Vycm9yJywgKGVycjogRXJyb3IpID0+IHtcbiAgICBjb25zb2xlLmVycm9yKCfimqDvuI8nLCBlcnIubWVzc2FnZSlcbiAgICBwcm9jZXNzLmV4aXQoMSlcbiAgfSlcblxuICBzdHJlYW0ub24oJ29wZW4nLCAoKSA9PiB7XG4gICAgLy8gY29uc29sZS5sb2coJ0JFR0lOIScpO1xuICB9KVxuXG4gIHJsID0gY3JlYXRlSW50ZXJmYWNlKHsgaW5wdXQ6IHN0cmVhbSB9KVxuXG4gIGNvbnN0IGRhdGE6IERhdGFUeXBlID0geyB2ZXJzaW9uOiBlbW9qaVZlcnNpb24sIGVtb2ppczogW10gfVxuXG4gIGxldCBjdXJHcm91cCA9ICcnXG4gIGxldCBjdXJTdWJncm91cCA9ICcnXG5cbiAgcmwub24oJ2xpbmUnLCAobGluZSkgPT4ge1xuICAgIGlmIChsaW5lLmNoYXJBdCgwKSA9PT0gJyMnKSB7XG4gICAgICBjb25zdCB2ZXJzaW9uID0gLyNcXHMrdmVyc2lvbjpcXHMrKC4rKS9pLmV4ZWMobGluZSlcbiAgICAgIGNvbnN0IGdyb3VwID0gLyNcXHMrZ3JvdXA6XFxzKyguKykvLmV4ZWMobGluZSlcbiAgICAgIGNvbnN0IHN1Ymdyb3VwID0gLyNcXHMrc3ViZ3JvdXA6XFxzKyguKykvLmV4ZWMobGluZSlcbiAgICAgIC8vIHZlcnNpb25cbiAgICAgIGlmICh2ZXJzaW9uICE9IG51bGwpIHtcbiAgICAgICAgZGF0YS52ZXJzaW9uID0gdmVyc2lvblsxXVxuICAgICAgfVxuICAgICAgLy8gZ3JvdXBcbiAgICAgIGlmIChncm91cCAhPSBudWxsKSB7XG4gICAgICAgIGN1ckdyb3VwID0gZ3JvdXBbMV1cbiAgICAgIH1cbiAgICAgIC8vIHN1Ymdyb3VwXG4gICAgICBpZiAoc3ViZ3JvdXAgIT0gbnVsbCkge1xuICAgICAgICBjdXJTdWJncm91cCA9IHN1Ymdyb3VwWzFdXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGVtb2ppXG4gICAgICAvLyAjIEZvcm1hdDogY29kZSBwb2ludHM7IHN0YXR1cyAjIGVtb2ppIG5hbWVcbiAgICAgIC8vICAgICAgICAgICBbMV0gICAgICAgICAgWzJdICAgICAgWzNdICAgWzRdXG4gICAgICBjb25zdCBlbW9qaUluZm8gPSAvXihbXFx3XFxzXSs/KVxccys7XFxzKyhbXFx3LV0rKVxccysjXFxzKyhcXFMrKVxccysoLispLy5leGVjKFxuICAgICAgICBsaW5lXG4gICAgICApXG5cbiAgICAgIGVtb2ppSW5mbyAhPSBudWxsICYmXG4gICAgICAgIGRhdGEuZW1vamlzLnB1c2goe1xuICAgICAgICAgIGdyb3VwOiBjdXJHcm91cCxcbiAgICAgICAgICBzdWJncm91cDogY3VyU3ViZ3JvdXAsXG4gICAgICAgICAgY29kZXBvaW50czogZW1vamlJbmZvWzFdLnJlcGxhY2UoL1xccysvZywgJywnKSxcbiAgICAgICAgICBzdGF0dXM6IGVtb2ppSW5mb1syXSxcbiAgICAgICAgICBlbW9qaTogZW1vamlJbmZvWzNdLFxuICAgICAgICAgIG5hbWU6IGVtb2ppSW5mb1s0XSxcbiAgICAgICAgICBrZXl3b3JkczogZ2V0S2V5V29yZHMoY3VyR3JvdXAsIGN1clN1Ymdyb3VwLCBlbW9qaUluZm9bNF0pXG4gICAgICAgIH0pXG4gICAgfVxuICB9KVxuICBybC5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgZm9ybWF0KGRhdGEsIGFyZ3YudHlwZSlcbiAgICAgIC50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgd3JpdGVGaWxlKG91dHB1dCwgcmVzdWx0LCAoZXJyKSA9PiB7XG4gICAgICAgICAgaWYgKGVyciAhPSBudWxsKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCfimqDvuI8nLCBlcnIubWVzc2FnZSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICfinIzvuI8nLFxuICAgICAgICAgICAgICBg77iPUGxlYXNlIHJ1biBcXGBvcGVuIFwiJHtvdXRwdXR9XCJcXGAgdG8gY2hlY2sgdGhlIG91dHB1dC5gXG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KaoO+4jycsIGVyci5tZXNzYWdlKVxuICAgICAgfSlcbiAgfSlcbn0pKClcblxuY29uc3QgZ2V0S2V5V29yZHMgPSAoZ3JvdXA6IHN0cmluZywgc3ViZ3JvdXA6IHN0cmluZywgbmFtZTogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgY29uc3Qgc2VwYXJhdG9yID0gL1tcXHMmXFwtOl0rL1xuICBsZXQga2V5d29yZHM6IHN0cmluZ1tdID0gW11cblxuICBuYW1lID0gbmFtZS5yZXBsYWNlKC9bKCldL2csICcnKVxuXG4gIGtleXdvcmRzID0ga2V5d29yZHMuY29uY2F0KGdyb3VwLnRvTG93ZXJDYXNlKCkuc3BsaXQoc2VwYXJhdG9yKSlcbiAga2V5d29yZHMgPSBrZXl3b3Jkcy5jb25jYXQoc3ViZ3JvdXAudG9Mb3dlckNhc2UoKS5zcGxpdChzZXBhcmF0b3IpKVxuICBrZXl3b3JkcyA9IGtleXdvcmRzLmNvbmNhdChuYW1lLnRvTG93ZXJDYXNlKCkuc3BsaXQoc2VwYXJhdG9yKSlcblxuICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KGtleXdvcmRzKSkuam9pbigpXG59XG4iXX0=